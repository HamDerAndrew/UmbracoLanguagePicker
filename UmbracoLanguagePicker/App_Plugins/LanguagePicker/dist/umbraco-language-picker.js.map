{"version":3,"file":"umbraco-language-picker.js","sources":["../src/umbraco-language-picker.element.ts"],"sourcesContent":["import { LitElement, html, css, customElement, property, state } from \"@umbraco-cms/backoffice/external/lit\";\r\nimport { UmbPropertyValueChangeEvent} from \"@umbraco-cms/backoffice/property-editor\";\r\n// Needed for language picker config values 'allowNull' and 'uniqueFilter'\r\nimport { type UmbPropertyEditorConfigCollection } from \"@umbraco-cms/backoffice/property-editor\";\r\nimport { UmbPropertyEditorUiElement } from \"@umbraco-cms/backoffice/extension-registry\";\r\nimport { UmbElementMixin } from \"@umbraco-cms/backoffice/element-api\";\r\n// @ts-ignore\r\nimport { UmbWorkspaceContext, UMB_WORKSPACE_CONTEXT } from \"@umbraco-cms/backoffice/workspace\";\r\nimport { UMB_AUTH_CONTEXT, UmbAuthContext } from \"@umbraco-cms/backoffice/auth\";\r\nimport { UMB_PROPERTY_CONTEXT } from '@umbraco-cms/backoffice/property';\r\nimport { UmbLanguageCollectionRepository } from \"@umbraco-cms/backoffice/language\";\r\nimport { UUISelectEvent } from \"@umbraco-cms/backoffice/external/uui\";\r\nimport type { UmbMenuStructureWorkspaceContext, UmbStructureItemModel } from '@umbraco-cms/backoffice/menu';\r\n\r\n@customElement('umbraco-language-picker')\r\nexport default class UmbracoLanguagePickerElement extends UmbElementMixin(LitElement) implements UmbPropertyEditorUiElement\r\n{\r\n  @property()\r\n  // @ts-ignore\r\n  public value: string;\r\n  \r\n  @property()\r\n  public displayValue: string | undefined;\r\n  \r\n  @property()\r\n  public languageList: object[] = []\r\n  \r\n  @property()\r\n  public contentNodeId: string | undefined;\r\n  \r\n  @property()\r\n  public myAuthToken: Promise<string> | undefined;\r\n  \r\n  @property()\r\n  public currentAlias = \"\"\r\n  \r\n  @property()\r\n  public contentParentNode = \"\"\r\n  \r\n  @property()\r\n  public languageError: boolean = false;\r\n  \r\n  @property()\r\n  public mappedLanguageList: any = {}\r\n  \r\n  @property()\r\n  private _lowerCaseNone: string = \"\";\r\n  \r\n  @property({attribute: false})\r\n  public set config(config: UmbPropertyEditorConfigCollection) {\r\n    this._allowNull = config.getValueByAlias(\"allowNull\");\r\n    this._uniqueFilter = config.getValueByAlias(\"uniqueFilter\");\r\n  }\r\n  \r\n  @state()\r\n  isEditing: boolean = false;\r\n  \r\n  @state()\r\n  private _allowNull?: boolean;\r\n  \r\n  @state()\r\n  private _uniqueFilter?: boolean\r\n  \r\n  @state()\r\n  // @ts-ignore\r\n  private _selectedLanguage?: string;\r\n  // @ts-ignore\r\n  private languageCollectionRepository = new UmbLanguageCollectionRepository(this)\r\n\r\n  // @ts-ignore\r\n  private authorizationContext: UmbAuthContext;\r\n  // @ts-ignore\r\n  private myToken: Promise<string>;\r\n\r\n  #workspaceContext?: any;\r\n  #structureContext?: UmbMenuStructureWorkspaceContext;\r\n\r\n  constructor() {\r\n    super();\r\n    this.consumeContext(UMB_WORKSPACE_CONTEXT, (context) => {\r\n      this.#workspaceContext = context;\r\n        //grab the node id (guid) from the context\r\n        // @ts-ignore\r\n      this.contentNodeId = context.getUnique();\r\n      // context.getEntityType()\r\n    });\r\n    this.consumeContext(UMB_AUTH_CONTEXT, (context) => {\r\n      this.authorizationContext = context;\r\n      this.myAuthToken = context.getLatestToken();\r\n    })\r\n    // To get the alias of the UmbracoLanguagePicker property editor you need to use this\r\n    this.consumeContext(UMB_PROPERTY_CONTEXT, (propertyContext) => {\r\n      this.observe(propertyContext.alias, async (propertyAlias) => {\r\n        // @ts-ignore\r\n        this.currentAlias = propertyAlias\r\n      })\r\n    })\r\n    this.consumeContext('UmbMenuStructureWorkspaceContext', (instance: any) => {\r\n      this.#structureContext = instance as UmbMenuStructureWorkspaceContext;\r\n\t\t\tthis.#observeStructure();\r\n    });\r\n  }\r\n  \r\n  #observeStructure() {\r\n\t\tif (!this.#structureContext || !this.#workspaceContext) return;\r\n\t\tconst isNew = this.#workspaceContext.getIsNew();\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis.#structureContext.structure,\r\n\t\t\t(value) => {\r\n\t\t\t\t// TODO: get the type from the context\r\n\t\t\t\tconst structure = value as Array<UmbStructureItemModel>;\r\n        if(isNew)\r\n        {\r\n          if(this.isDocumentRoot())\r\n          {\r\n            // @ts-ignore\r\n            this.contentParentNode = null;\r\n          }\r\n          else\r\n          {\r\n            // @ts-ignore\r\n            this.contentParentNode = structure[structure.length - 1]?.unique;    \r\n          }\r\n        }\r\n        else\r\n        {\r\n          // @ts-ignore\r\n          this.contentParentNode = structure[structure.length - 2]?.unique;  \r\n        }\r\n\t\t\t},\r\n\t\t\t'menuStructureObserver',\r\n\t\t);\r\n\t}\r\n\r\n  isDocumentRoot() : boolean {\r\n    return location.href.split(\"/\").indexOf('document-root') > -1;\r\n  }\r\n  \r\n  async firstUpdated(changed: any) {\r\n    super.firstUpdated(changed)\r\n    const {data} = await this.languageCollectionRepository.requestCollection({})\r\n    this.mappedLanguageList[this._lowerCaseNone] = \"NONE\";\r\n    data?.items.forEach(element => {\r\n      this.mappedLanguageList[element.unique.toLowerCase()] = element.name\r\n    })\r\n    this.displayValue = this.mappedLanguageList[this.value || \"\"];\r\n    this.getLanguages()\r\n  }\r\n\r\n\r\n  private async getLanguages() {\r\n    try {\r\n      const promiseToken = await this.myAuthToken;\r\n      const headers = {\r\n        Authorization: `Bearer ${promiseToken}`\r\n      };\r\n      const baseEndpoint = \"/umbraco/management/api/v1/get-key-value-list\"\r\n      const data = await fetch(`${baseEndpoint}?parentNodeIdOrGuid=${this.contentParentNode}&nodeIdOrGuid=${this.contentNodeId}&propertyAlias=${this.currentAlias}&uniqueFilter=${!!this._uniqueFilter}&allowNull=${!!this._allowNull}`, {headers});\r\n      const dataJson = await data.json()\r\n        // Need to map it so the uui element can accept and display the data: https://uui.umbraco.com/?path=/docs/uui-select--docs\r\n      const mappedData = dataJson.map((language:any) => {\r\n        return { name: this.mappedLanguageList[language.key] || \"NONE\", value: language.key || this._lowerCaseNone, selected: language.key === this.value}\r\n      })\r\n      const mappedValue = mappedData.find((element:any) => element.value === this.value)\r\n      this.languageList = mappedData;\r\n      if(mappedValue) {\r\n        this.displayValue = this.mappedLanguageList[mappedValue.value];\r\n      }\r\n      this.languageError = false;\r\n    } catch (error) {\r\n      this.languageError = true;\r\n      console.error(error)\r\n    }\r\n  }\r\n  \r\n  private handleSelectChange(e: UUISelectEvent) {\r\n    const langValue = e.target.value as string;\r\n    this.value = langValue;\r\n    this._selectedLanguage = langValue\r\n    \r\n    this.dispatchEvent(new UmbPropertyValueChangeEvent());\r\n  }\r\n\r\n  render() {\r\n    return html`\r\n      ${this.isEditing ? \r\n          html`<uui-select .value=${this.value} label=\"select language\" .options=${this.languageList} placeholder=${this._allowNull ? \"NONE\" : \"Select an option\"} @change=${this.handleSelectChange}></uui-select>`\r\n          :\r\n          html`<span class=\"editing-text\">${this.displayValue ? this.displayValue : \"Select language\"}</span>\r\n          <uui-button look=\"secondary\" color=\"default\" class=\"data-api-picker-edit-label\" role=\"button\" @click=${() => this.isEditing = !this.isEditing}>\r\n            <umb-localize key=\"umbracoLanguagePicker_edit\">\r\n              Edit\r\n            </umb-localize>\r\n          </uui-button>`}\r\n        ${this.languageError ?  html`<p>error when fetching languages</p>` : \"\" }\r\n    `;\r\n  }\r\n\r\n  static styles = [\r\n    css`\r\n      .data-api-picker-edit-label {\r\n        font-size: 13px;\r\n      }\r\n      .data-api-picker-edit-label:hover {\r\n        color: #515054;\r\n      }\r\n      \r\n      .editing-text {\r\n        padding-right: 12px;\r\n      }\r\n    `\r\n  ];\r\n  \r\n}\r\n\r\ndeclare global {\r\n  interface HTMLElementTagNameMap {\r\n    'umbraco-language-picker': UmbracoLanguagePickerElement;\r\n  }\r\n}\r\n"],"names":["_workspaceContext","_structureContext","_observeStructure","observeStructure_fn","UmbracoLanguagePickerElement","UmbElementMixin","LitElement","__privateAdd","UmbLanguageCollectionRepository","UMB_WORKSPACE_CONTEXT","context","__privateSet","UMB_AUTH_CONTEXT","UMB_PROPERTY_CONTEXT","propertyContext","propertyAlias","instance","__privateMethod","config","changed","data","element","headers","mappedData","language","mappedValue","error","langValue","UmbPropertyValueChangeEvent","html","__privateGet","isNew","value","structure","_a","_b","css","__decorateClass","property","state","customElement"],"mappings":"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"}